<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>DNS-Over-TLS Client Setup &middot; Pat~ Pat~ Meow~</title>
  <meta name="description" content="DoT 是一项新兴的 DNS 查询方式，本文主要介绍作者尝试部署 DoT 服务器的一次实践。" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://www.kmahyyg.xyz/css/main.min.css" />
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-123948588-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  <style>
    body {
      background: #ecedef url("https://alicdn.kmahyyg.xyz/asset_files/aether/bgimg.webp") repeat;
    }
  </style>
</head>
  <body class="single-body">
    <nav class="nav-bar side-padding">
  <h1 class="nav-header"><a href="https://www.kmahyyg.xyz/" class="nav-text">Patrick Young</a></h1>
  <div class="hamburger-menu">
    <button onclick="hamburgerMenuPressed.call(this)" aria-haspopup="true" aria-expanded="false" aria-controls="menu" aria-label="Menu">
      <span></span>
      <span></span>
    </button>
    <ul id="menu" class="hamburger-menu-overlay">
      <li><a href="https://www.kmahyyg.xyz/" class="hamburger-menu-overlay-link">Home</a></li>
      <li><a href="https://www.kmahyyg.xyz/express-page/" class="hamburger-menu-overlay-link">Express Inc</a></li>
      <li><a href="https://www.kmahyyg.xyz/about-me-page/" class="hamburger-menu-overlay-link">About</a></li>
      <li><a href="https://www.kmahyyg.xyz/archlinux-bug-page/" class="hamburger-menu-overlay-link">Arch Linux</a></li>
      <li><a href="https://www.kmahyyg.xyz/donate-page/" class="hamburger-menu-overlay-link">Donate</a></li>
      <li><a href="https://www.kmahyyg.xyz/categories/code" class="hamburger-menu-overlay-link">Code</a></li><li><a href="https://www.kmahyyg.xyz/categories/life" class="hamburger-menu-overlay-link">Life</a></li><li><a href="https://www.kmahyyg.xyz/categories/network" class="hamburger-menu-overlay-link">Network</a></li><li><a href="https://www.kmahyyg.xyz/categories/school" class="hamburger-menu-overlay-link">School</a></li><li><a href="https://www.kmahyyg.xyz/categories/tech" class="hamburger-menu-overlay-link">Tech</a></li>
    </ul>
  </div>
</nav>
    <main class="content side-text-padding">
      <article class="post ">
        <header class="post-header">
        	<h1 class="post-title">DNS-Over-TLS Client Setup</h1>
          <p class="post-date">Posted <time datetime="2018-04-02">Apr 2, 2018</time></p>
        </header>
        
        <picture class="post-figure">
            
            <source srcset="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_network.webp">
          <img src="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_network.webp" >
        </picture>
        
        

<h1 id="preface">Preface</h1>

<p>Read this to know what you should know before you skim my article:</p>

<ul>
<li><a href="https://tenta.com/blog/post/2017/12/dns-over-tls-vs-dnscrypt">DNS-Over-TLS vs DNSCrypt</a></li>
<li><a href="https://tools.ietf.org/html/rfc7858">Technical details in RFC7858</a></li>
<li><a href="https://www.quad9.net">Quad9 DNS</a> offered by IBM.</li>
<li><a href="https://1.1.1.1">Cloudflare DNS</a> This DNS is the fastest ever DNS, but working much more unstable in China Mainland. This DNS doesn&rsquo;t provide any EDNS support.</li>
<li><a href="https://developers.cloudflare.com/1.1.1.1/dns-over-tls/">DNS-Over-TLS test via Knot-DIG</a></li>
</ul>

<h1 id="preparation">Preparation</h1>

<ol>
<li><p>From your DNS Provider, do a cross-check whether it support DNS-Over-TLS or not.</p></li>

<li><p>Copy the SSL certificate PIN and hostname (PIN must encoded in SHA256 with Base64 Encoded) to let resolver confirm DNS certificate.You can get it from <code>kdig</code> result in a reliable network or provider&rsquo;s website.</p></li>
</ol>

<p>For example:</p>

<pre><code class="language-bash">    [kmahyyg@PatrickY  /etc] $ kdig -d @1.1.1.1 +tls-ca +tls-host=cloudflare-dns.com baidu.com
   ;; DEBUG: Querying for owner(baidu.com.), class(1), type(1), server(1.1.1.1), port(853), protocol(TCP)
   ;; DEBUG: TLS, imported 166 system certificates
   ;; DEBUG: TLS, received certificate hierarchy:
   ;; DEBUG:  #1, C=US,ST=CA,L=San Francisco,O=Cloudflare\, Inc.,CN=*.cloudflare-dns.com
   ;; DEBUG:      SHA-256 PIN: yioEpqeR4WtDwE9YxNVnCEkTxIjx6EEIwFSQW+lJsbc=
   ;; DEBUG:  #2, C=US,O=DigiCert Inc,CN=DigiCert ECC Secure Server CA
   ;; DEBUG:      SHA-256 PIN: PZXN3lRAy+8tBKk2Ox6F7jIlnzr2Yzmwqc3JnyfXoCw=
   ;; DEBUG: TLS, skipping certificate PIN check
   ;; DEBUG: TLS, The certificate is trusted. 
   ;; TLS session (TLS1.2)-(ECDHE-ECDSA-SECP256R1)-(AES-256-GCM)
   ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY; status: NOERROR; id: 58591
   ;; Flags: qr rd ra; QUERY: 1; ANSWER: 2; AUTHORITY: 0; ADDITIONAL: 1

   ;; EDNS PSEUDOSECTION:
   ;; Version: 0; flags: ; UDP size: 1536 B; ext-rcode: NOERROR
   ;; PADDING: 394 B

   ;; QUESTION SECTION:
   ;; baidu.com.          		IN	A

   ;; ANSWER SECTION:
   baidu.com.          	466	IN	A	111.13.101.208
   baidu.com.          	466	IN	A	220.181.57.216

   ;; Received 468 B
   ;; Time 2018-04-02 21:48:03 CST
   ;; From 1.1.1.1@853(TCP) in 193.7 ms
</code></pre>

<ol>
<li>According to popularity, we have two methods to use DNS-Over-TLS as a client. More details, see <a href="https://dnsprivacy.org/wiki/display/DP/DNS+Privacy+Clients">DNS Privacy</a></li>
</ol>

<p>(1) Unbound + Stubby.</p>

<p>The Stubby is a TCP request forwarder working behind Unbound. Configuration are distributed all the internet.</p>

<p>Unbound is a famous DNS server.</p>

<p>(2) Knot Resolver</p>

<p>Knot Resolver is created by CZ.NIC Labs, which has Knot DNS Server and Knot Dig.</p>

<p>Knot Resolver is written in C &amp; Golang &amp; Lua, with a highly extensible framework, working as a full-featured DNS relay.</p>

<p>Today, I&rsquo;m going to introduce Knot Resolver to you.</p>

<h1 id="installation-and-deployment">Installation and Deployment</h1>

<p>All examples is tested to be working properly under Deepin Linux, which is Debian Sid based.</p>

<p>If you have a Debian-based *nix System, this tutorial should work.</p>

<p>Check whether a software is listening 53,853 ports first.</p>

<h2 id="1-unbound-with-stubby-all-simple">(1)Unbound with Stubby: All simple</h2>

<h3 id="install-unbound-first">Install Unbound first</h3>

<pre><code class="language-bash"># apt update -y &amp;&amp; apt install unbound -y
</code></pre>

<h3 id="install-stubby">Install Stubby</h3>

<p>Cuz Stubby only exists in sid, and its dependencies is lacked in the current repository. So, I recommend you to compile from source directly.</p>

<p>Stubby relies on GetDNS. But the GetDNS in Debian is so old, so you still need to compile it yourself at the very beginning.</p>

<h3 id="dependencies-and-compile">Dependencies and compile</h3>

<pre><code class="language-bash"># apt install build-essential libunbound-dev libidn2-dev libssl-dev libtool m4 autoconf libyaml-dev #Note: libidn2-0-dev maybe used here.
</code></pre>

<h4 id="compile-getdns-with-with-stubby">Compile GetDNS with &ndash;with-stubby</h4>

<p>Here, we chose to install at /usr/local/getdns</p>

<pre><code class="language-bash"># git clone https://github.com/getdnsapi/getdns.git
# git submodule update --init
# libtoolize -ci # (use glibtoolize for OS X, libtool is installed as glibtool to avoid name conflict on OS X)
# autoreconf -fi
# mkdir /usr/local/getdns
# ./configure --prefix=/usr/local/getdns --without-libidn --enable-stub-only --with-stubby
# make
# make install
# ldconfig
# ln -s /usr/local/getdns/bin/stubby /usr/bin/stubby
</code></pre>

<p>After you successfully compiled, try <code>sudo stubby -lv</code> to check.</p>

<h3 id="configuration-in-unbound-and-stubby">Configuration in Unbound and Stubby</h3>

<pre><code class="language-bash"># unbound-anchor
# touch /var/run/unbound.pid
# touch /var/log/unbound.log &amp;&amp; chmod 666 /var/log/unbound.log
</code></pre>

<p>Refresh root hints first.</p>

<p>Directly Clone the repo listed below and put the configure file in the proper location.</p>

<p>For example:</p>

<ul>
<li>Unbound: /etc/unbound</li>
<li>Stubby: /usr/local/getdns/etc/stubby</li>
</ul>

<pre><code class="language-bash">$ git clone https://github.com/kmahyyg/DoT_1111.git
</code></pre>

<h4 id="performance">Performance</h4>

<p>So poor. Average time cost is 1.+s ~ 3.+s. It depends on the network environment and how much GFW involved in, cause GFW usually give network data packet which transferred to outside China mainland a TCP_CONN_RESET.</p>

<p>FUCK U, CCP!</p>

<p>FUCK U, GFW!</p>

<h2 id="2-knot-resolver-simple-config-with-complicated-installer">(2)Knot-Resolver: Simple config with complicated installer</h2>

<h3 id="compile-from-source">Compile from source</h3>

<p>See <a href="https://github.com/CZ-NIC/knot-resolver">Github</a> for more details including Docker image.</p>

<h3 id="configuration">Configuration</h3>

<pre><code class="language-bash">root@hostname # vi /etc/knot-resolver/kresd.conf
root@hostname # mkdir /tmp/kresd-cache.mdb
root@hostname # cat /etc/hosts &gt; /etc/hosts.y.kresd
</code></pre>

<pre><code>-- Default empty Knot DNS Resolver configuration in -*- lua -*-

-- Bind ports as privileged user (root) --
net = { '127.0.0.1', '::1' }

-- Unprivileged user --
user('knot-resolver','knot-resolver')

-- Cache related --
cache.size = 50*MB
event.recurrent(60 * minute, function()
        cache.prune()
end)

cache.storage = 'lmdb:///tmp/kresd-cache.mdb'

-- Load modules --
modules = {
    'policy &lt; hints',
    'hints &gt; iterate',
    'daf'
}

-- Add custom hosts file --
hint.add_hosts('/etc/hosts.y.kresd')

-- DNS Firewall --
daf.add 'qname ~ (api|ps|sv|offnavi|newvector|ulog.imap|newloc)(.map|).(baidu|n.shifen).com deny'
daf.add 'qname ~ (.+.|^)(360|so).(cn|com) deny'
daf.add 'qname ~ (.*.||)(dafahao|minghui|dongtaiwang|epochtimes|ntdtv|falundafa|wujieliulan).(org|com|net) deny'
daf.add 'qname ~ (.*.||)(guerrillamail|guerrillamailblock|sharklasers|grr|pokemail|spam4|bccto|chacuo|027168).(info|biz|com|de|net|org|me|la) deny'

-- At this time, no DNS64 support --
-- Now supported: DNSSEC --

-- BEGIN: DNS over TLS --
policy.add(policy.all(policy.TLS_FORWARD({{'1.1.1.1', pin_sha256={'yioEpqeR4WtDwE9YxNVnCEkTxIjx6EEIwFSQW+lJsbc=','PZXN3lRAy+8tBKk2Ox6F7jIlnzr2Yzmwqc3JnyfXoCw='}}})))
-- END: DNS over TLS --
</code></pre>

<h4 id="test-for-performance">Test for performance</h4>

<p>Unable to do that. Strongly recommend you <strong>NOT</strong> to use this method because this package doesn&rsquo;t have any modules built-in except <code>iterator,cache,validator</code> , you&rsquo;ll need to compile all modules inneed by yourself. I didn&rsquo;t go through this method.</p>

<h1 id="conclusion">Conclusion</h1>

<p>NOT RECOMMEND TO USE THIS AS A PRIMARY DNS METHOD BECAUSE OF POOR CONNECTIVITY IN CHINA.</p>

<h1 id="more-questions">More questions</h1>

<p>Feel free to contact me via comments at the bottom of the text or use TG to get in touch with me.</p>

      </article>
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "kmahyyg" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </main>
    <nav class="end-nav side-padding">
      
      <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="https://www.kmahyyg.xyz/" class="card home-card" style="background-image: url( https://alicdn.kmahyyg.xyz/asset_files/aether/backtohome.webp )" rel="bookmark" >
  Home
</a>
    </nav>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>
<script src="https://www.kmahyyg.xyz/js/core.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
  </body>
</html>