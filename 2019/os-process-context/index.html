<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.5.6 -->
    <script>
        window.materialVersion = "1.5.6"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1',
            '1.5.0',
            '1.5.2',
            '1.5.5'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">

    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source"/>





    <link rel="dns-prefetch" href="https://kmahyyg.disqus.com"/>



    <link rel="dns-prefetch" href="https://www.google-analytics.com"/>



    <link rel="dns-prefetch" href="https://lib.baomitu.com"/>





    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!-- Title -->
    
    <title>
        
            操作系统原理 - 用户空间、内核空间与上下文 | 
        
        Potato Online
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="https://alicdn.kmahyyg.xyz/asset_files/avatar-yyg.jpg">
    <link rel="icon" href="https://alicdn.kmahyyg.xyz/asset_files/avatar-yyg.jpg">

    <meta name="format-detection" content="telephone=no"/>
    <meta name="description" itemprop="description" content="Resources determined everything.">
    <meta name="keywords" content="Patrick Young,kmahyyg,material,School">
    <meta name="theme-color" content="#0097A7">

    <!-- Disable Fucking Bloody Baidu Tranformation -->
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(a){try{localStorage.removeItem(a)}catch(b){}};lsloader.setLS=function(a,c){try{localStorage.setItem(a,c)}catch(b){}};lsloader.getLS=function(a){var c="";try{c=localStorage.getItem(a)}catch(b){c=""}return c};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var b=[];for(var a=0;a<localStorage.length;a++){b.push(localStorage.key(a))}b.forEach(function(e){var f=lsloader.getLS(e);if(window.oldVersion){var d=window.oldVersion.reduce(function(g,h){return g||f.indexOf("/*"+h+"*/")!==-1},false);if(d){lsloader.removeLS(e)}}})}catch(c){}};lsloader.clean();lsloader.load=function(f,a,b,d){if(typeof b==="boolean"){d=b;b=undefined}d=d||false;b=b||function(){};var e;e=this.getLS(f);if(e&&e.indexOf(versionString)===-1){this.removeLS(f);this.requestResource(f,a,b,d);return}if(e){var c=e.split(versionString)[0];if(c!=a){console.log("reload:"+a);this.removeLS(f);this.requestResource(f,a,b,d);return}e=e.split(versionString)[1];if(d){this.jsRunSequence.push({name:f,code:e});this.runjs(a,f,e)}else{document.getElementById(f).appendChild(document.createTextNode(e));b()}}else{this.requestResource(f,a,b,d)}};lsloader.requestResource=function(b,e,a,c){var d=this;if(c){this.iojs(e,b,function(h,f,g){d.setLS(f,h+versionString+g);d.runjs(h,f,g)})}else{this.iocss(e,b,function(f){document.getElementById(b).appendChild(document.createTextNode(f));d.setLS(b,e+versionString+f)},a)}};lsloader.iojs=function(d,b,g){var a=this;a.jsRunSequence.push({name:b,code:""});try{var f=new XMLHttpRequest();f.open("get",d,true);f.onreadystatechange=function(){if(f.readyState==4){if((f.status>=200&&f.status<300)||f.status==304){if(f.response!=""){g(d,b,f.response);return}}a.jsfallback(d,b)}};f.send(null)}catch(c){a.jsfallback(d,b)}};lsloader.iocss=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.iofonts=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.runjs=function(f,c,e){if(!!c&&!!e){for(var b in this.jsRunSequence){if(this.jsRunSequence[b].name==c){this.jsRunSequence[b].code=e}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var a=document.createElement("script");a.appendChild(document.createTextNode(this.jsRunSequence[0].code));a.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(a);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else{if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var d=this;var a=document.createElement("script");a.src=this.jsRunSequence[0].path;a.type="text/javascript";this.jsRunSequence[0].status="loading";a.onload=function(){d.jsRunSequence.shift();if(d.jsRunSequence.length>0){d.runjs()}};document.body.appendChild(a)}}};lsloader.tagLoad=function(b,a){this.jsRunSequence.push({name:a,code:"",path:b,status:"failed"});this.runjs()};lsloader.jsfallback=function(c,b){if(!!this.jsnamemap[b]){return}else{this.jsnamemap[b]=b}for(var a in this.jsRunSequence){if(this.jsRunSequence[a].name==b){this.jsRunSequence[a].code="";this.jsRunSequence[a].status="failed";this.jsRunSequence[a].path=c}}this.runjs()};lsloader.cssfallback=function(e,c,b){if(!!this.cssnamemap[c]){return}else{this.cssnamemap[c]=1}var d=document.createElement("link");d.type="text/css";d.href=e;d.rel="stylesheet";d.onload=d.onerror=b;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(d,a)};lsloader.runInlineScript=function(c,b){var a=document.getElementById(b).innerText;this.jsRunSequence.push({name:c,code:a});this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source/css/material.min.css",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source/css/style.min.css",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        
            
                <style id="prettify_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("prettify_css","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source/css/prettify.min.css",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
                <style id="prettify_theme"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("prettify_theme","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source/css/prettify/github-v2.min.css",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
            
        

    

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <style>
        @font-face {
            font-family: Roboto;
            font-style: normal;
            font-weight: 300;
            src: url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-300.eot);
            src: local('Roboto'),local('Roboto-Normal'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-300.eot?#iefix) format('embedded-opentype'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-300.woff2) format('woff2'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-300.woff) format('woff'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-300.ttf) format('truetype'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-300.svg#Roboto) format('svg')
        }

        @font-face {
            font-family: Roboto;
            font-style: normal;
            font-weight: regular;
            src: url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-regular.eot);
            src: local('Roboto'),local('Roboto-Normal'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-regular.eot?#iefix) format('embedded-opentype'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-regular.woff2) format('woff2'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-regular.woff) format('woff'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-regular.ttf) format('truetype'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-regular.svg#Roboto) format('svg')
        }

        @font-face {
            font-family: Roboto;
            font-style: normal;
            font-weight: 500;
            src: url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-500.eot);
            src: local('Roboto'),local('Roboto-Normal'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-500.eot?#iefix) format('embedded-opentype'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-500.woff2) format('woff2'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-500.woff) format('woff'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-500.ttf) format('truetype'),url(https://lib.baomitu.com/fonts/roboto/roboto-v15-latin-500.svg#Roboto) format('svg')
        }
    </style>


<!-- Import Material Icons -->


    <style id="material_icons"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_icons","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source/css/material-icons.css",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","https://cdn.jsdelivr.net/npm/jquery@2.2.0/dist/jquery.min.js", true)</script>
    

    <!-- WebAPP Icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Potato Online">
    <meta name="msapplication-starturl" content="https://www.kmahyyg.xyz/2019/os-process-context/">
    <meta name="msapplication-navbutton-color" content="#0097A7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Potato Online">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="https://alicdn.kmahyyg.xyz/asset_files/avatar-yyg.jpg">

    <!-- Site Verification -->
    
    

    <!-- RSS -->
    
        
            <link rel=alternate type="application/atom+xml" href="/atom.xml">
        
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="https://www.kmahyyg.xyz/2019/os-process-context/">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="操作系统原理 - 用户空间、内核空间与上下文 | Potato Online">
    <meta property="og:image" content="https://alicdn.kmahyyg.xyz/asset_files/avatar-yyg.jpg">
    <meta property="og:description" content="Resources determined everything.">
    <meta property="og:article:tag" content="School"> 

    
        <meta property="article:published_time" content="Mon Apr 08 2019 00:51:52 GMT+0000">
        <meta property="article:modified_time" content="Mon Apr 08 2019 17:10:04 GMT+0000">
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:card" content="summary_large_image">

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="https://www.kmahyyg.xyz/2019/os-process-context/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "https://www.kmahyyg.xyz/2019/os-process-context/index.html",
    "headline": "操作系统原理 - 用户空间、内核空间与上下文",
    "datePublished": "Mon Apr 08 2019 00:51:52 GMT+0000",
    "dateModified": "Mon Apr 08 2019 17:10:04 GMT+0000",
    "author": {
        "@type": "Person",
        "name": "Patrick Young",
        "image": {
            "@type": "ImageObject",
            "url": "https://alicdn.kmahyyg.xyz/asset_files/avatar-yyg.jpg"
        },
        "description": "The man who control all the sources will control the whole world!"
    },
    "publisher": {
        "@type": "Organization",
        "name": "Potato Online",
        "logo": {
            "@type":"ImageObject",
            "url": "https://alicdn.kmahyyg.xyz/asset_files/avatar-yyg.jpg"
        }
    },
    "keywords": ",SchoolPatrick Young,kmahyyg,material",
    "description": "Resources determined everything.",
}
</script>


    

    <!-- Analytics -->
    
        <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-123948588-1', 'auto');ga('send', 'pageview');
</script>
    
    
    

    <!-- Custom Head -->
    

<link rel="stylesheet" href="/css/prism-vs.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span id="MD-burger-id" class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#警告"><span class="post-toc-number">1.</span> <span class="post-toc-text">警告</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#内核空间与用户空间"><span class="post-toc-number">2.</span> <span class="post-toc-text">内核空间与用户空间</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#定义与铺垫"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">定义与铺垫</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#虚拟内存地址"><span class="post-toc-number">2.1.1.</span> <span class="post-toc-text">虚拟内存地址</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#内核空间与用户空间-1"><span class="post-toc-number">2.1.2.</span> <span class="post-toc-text">内核空间与用户空间</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#32-位架构的机器"><span class="post-toc-number">2.1.2.1.</span> <span class="post-toc-text">32 位架构的机器</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#64-位架构的机器"><span class="post-toc-number">2.1.2.2.</span> <span class="post-toc-text">64 位架构的机器</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#关于内核空间与内存安全"><span class="post-toc-number">2.1.3.</span> <span class="post-toc-text">关于内核空间与内存安全</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#题外：那-Ring-1-和-Ring-2-呢？"><span class="post-toc-number">2.1.3.1.</span> <span class="post-toc-text">题外：那 Ring 1 和 Ring 2 呢？</span></a></li></ol></li></ol></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#上下文-Context"><span class="post-toc-number">3.</span> <span class="post-toc-text">上下文 Context</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#明确相关概念"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">明确相关概念</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#原子上下文"><span class="post-toc-number">3.1.1.</span> <span class="post-toc-text">原子上下文</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#关于-Linux-Kernel-的-preempt-count"><span class="post-toc-number">3.1.2.</span> <span class="post-toc-text">关于 Linux Kernel 的 preempt_count</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#上下文切换简述"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">上下文切换简述</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#进程上下文"><span class="post-toc-number">3.2.1.</span> <span class="post-toc-text">进程上下文</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#中断上下文"><span class="post-toc-number">3.2.2.</span> <span class="post-toc-text">中断上下文</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Linux-Kernel-的上下文切换-context-switch-实现"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">Linux Kernel 的上下文切换 context_switch 实现</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Reference"><span class="post-toc-number">4.</span> <span class="post-toc-text">Reference</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#各类博客"><span class="post-toc-number">4.0.0.1.</span> <span class="post-toc-text">各类博客</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#专业的问答网站和第三方文档"><span class="post-toc-number">4.0.0.2.</span> <span class="post-toc-text">专业的问答网站和第三方文档</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Linux-内核源代码"><span class="post-toc-number">4.0.0.3.</span> <span class="post-toc-text">Linux 内核源代码</span></a></li></ol></li></ol></li></ol></li></ol>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                操作系统原理 - 用户空间、内核空间与上下文
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="https://alicdn.kmahyyg.xyz/asset_files/avatar-yyg.jpg" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>Patrick Young</strong>
        <span>4月 08, 2019</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    
        <button id="article-functions-qrcode-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">devices other</i>
    <span class="visuallyhidden">devices other</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-qrcode-button">
    <li class="mdl-menu__item">在其它设备中阅读本文章</li>
    
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACW0lEQVR42u3aUW4CMQwFQO5/6fYAqMtznJiFTr5QEdtMkJLw7MfPV48HHh4eHh4eHh7ezXiPeDx/6vr18/P/+o/JZwtzw8PDwxvhvdhqL3nJVHL8hrnh4eHhDfKSaSWw5Ai5XpS1ueHh4eF9Ci+5ZCcMPDw8vP/DW5vcX+925oaHh4c3z0t+8PcZ/UPoYNaCh4eHF/PyItP869H6Hh4eHl7AK7c0tctaSfj7tp4yPDw8vIBXjVz7paxdBwMeHh7eHXjVRqu1Jq21JUsWEQ8PD2+GVw1qk809vzTni5gsEB4eHt4Mr1pwypsGOtfuvDELDw8Pb563tinncW31CMnjYzw8PLx38aoNVWth7mITwOVyl7MWPDw8vAO8fpRQ3frzCKOAx8PDwzvM61yskxii2hawFnPg4eHhzfP2Rq5rB8waqdw6gIeHh3eA15lo56KchBTbmq7w8PDwtvL2xrI5ZttRgYeHhzfIq0YJJya9dmDg4eHhTfKqU8mL/ck1PW+uyo8HPDw8vBleEitUmwmqse+2v+Dh4eEN8jqYTjTcaV8o9JTh4eHhHeDlB0O16NUphiUXazw8PLx38ZJSfV4wKxT7l4IPPDw8vHfxquPFphzEtfkirgXEeHh4eKd5/UJXNSzIg4+1choeHh7eDK96GCSbeF6+qj7zxdLj4eHhDfKqAeuuBqz8+dGXgYeHh3dLXqfYX12O8nPw8PDwPpCXbOt5qSyPIfDw8PDmeUkYsYZMwoi8bHYwxsXDw8M7UABLothq/Lqr3QoPDw9vhvd9Aw8PDw8PDw8P7wbjF++shpKNssI8AAAAAElFTkSuQmCC">
    
</ul>

    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/School/">School</a>
    </ul>
    

    <!-- Share -->
    
        <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=操作系统原理 - 用户空间、内核空间与上下文&url=https://www.kmahyyg.xyz/2019/os-process-context/index.html&via=Patrick Young" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=https://www.kmahyyg.xyz/2019/os-process-context/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=https://www.kmahyyg.xyz/2019/os-process-context/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    
        <a class="post_share-link" href="http://connect.qq.com/widget/shareqq/index.html?site=Potato Online&title=操作系统原理 - 用户空间、内核空间与上下文&summary=Resources determined everything.&pics=https://www.kmahyyg.xyzhttps://alicdn.kmahyyg.xyz/asset_files/avatar-yyg.jpg&url=https://www.kmahyyg.xyz/2019/os-process-context/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 QQ
            </li>
        </a>
    

    <!-- Share Telegram -->
    
        <a class="post_share-link" href="https://telegram.me/share/url?url=https://www.kmahyyg.xyz/2019/os-process-context/index.html&text=操作系统原理 - 用户空间、内核空间与上下文" target="_blank">
            <li class="mdl-menu__item">
                分享到 Telegram
            </li>
        </a>
    
</ul>

    
</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h1 id="警告"><a href="#警告" class="headerlink" title="警告"></a>警告</h1><p>本文很长，均为 Linux 实现，并将附赠源代码链接。请做好长时间阅读的准备。</p>
<p>作者的精力有限，本文将仅讨论 Linux Kernel 5.0.6 的 x86_32 和 x86_64 架构的相关实现。ARM 和 MIPS 架构在部分内容上有较大的区别，请有兴趣的读者自行 Google.</p>
<h1 id="内核空间与用户空间"><a href="#内核空间与用户空间" class="headerlink" title="内核空间与用户空间"></a>内核空间与用户空间</h1><p>下图是 Linux 的一个整体结构示意：</p>
<p><img src="https://alicdn.kmahyyg.xyz/asset_files/context_01_insidelinux.webp" alt="Kernel Memory Space"></p>
<h2 id="定义与铺垫"><a href="#定义与铺垫" class="headerlink" title="定义与铺垫"></a>定义与铺垫</h2><h3 id="虚拟内存地址"><a href="#虚拟内存地址" class="headerlink" title="虚拟内存地址"></a>虚拟内存地址</h3><p>我们首先需要明确的一点：现代操作系统为了性能考虑，全部采用了虚拟内存地址机制，来确保系统的高效运行。</p>
<p>那我们为什么需要采用虚拟内存地址：</p>
<ul>
<li>编译器编译产生的二进制运行产生的内存映像（Process Image）是将二进制文件中所有内容加载到内存的一个镜像，每一个函数都有一个 hardcoded 的保存地址，如果没有虚拟内存，想象一下多个程序同时运行的情况，必然产生代码冲突。</li>
<li>还是和上面一样，假设加载到内存地址产生冲突，但是恰好两部分代码一致，其中某一个程序出错了，这段内存被改写。另一个进程会因为这段被改写的内存空间而导致 crash.</li>
<li>同样的多进程环境，部分内存为了系统安全，应当不允许被系统内核之外的程序读取。如果不使用虚拟内存机制，难以对这一点做出保证。</li>
<li>假设采取内存分页机制，如果直接使用 direct address，不停的进行页交换，必然会导致严重的性能损耗。</li>
<li>根据硬件的不同，部分地址为某些硬件运行而预留，第三方改写或非法读取可能造成严重后果。</li>
<li>早期电脑的运行内存较小，虚拟内存机制可以将主存的部分空间用于临时充当内存。</li>
</ul>
<p>具体的对于内存地址的映射和管理问题，我们将在后续学习到内存调度时进一步阐述。</p>
<h3 id="内核空间与用户空间-1"><a href="#内核空间与用户空间-1" class="headerlink" title="内核空间与用户空间"></a>内核空间与用户空间</h3><h4 id="32-位架构的机器"><a href="#32-位架构的机器" class="headerlink" title="32 位架构的机器"></a>32 位架构的机器</h4><p>综上所述，我们在当前运行的电脑上（例如运行 gdb 调试程序时）看到的内存地址均为系统对物理内存进行映射后的虚拟地址。对于这部分地址的处理，Linux Kernel 在 32 位架构（最大内存寻址能力 4 GiB）的机器上将其分割为两部分，Low + High，比例为 Low: High = 3:1 ，具体的源代码可以参加 Linux 内核源码 <a href="https://elixir.bootlin.com/linux/v5.0.6/source/arch/x86/Kconfig#L1361" target="_blank" rel="noopener">arch/x86/Kconfig Line 1361</a>。对于 32 位架构，内存大于 4 GiB 的 Intel 机器，则内核会启用 Intel Physical Address Extension (PAE) 来扩展寻址到最大 64 GiB，这部分内容略去不表。</p>
<pre><code>Linux uses only 4 segments:

2 segments (code and data/stack) for KERNEL SPACE from [0xC000 0000] (3 GB) to [0xFFFF FFFF] (4 GB)
2 segments (code and data/stack) for USER SPACE from [0] (0 GB) to [0xBFFF FFFF] (3 GB)
                               __
   4 GB---&gt;|                |    |
           |     Kernel     |    |  Kernel Space (Code + Data/Stack)
           |                |  __|
   3 GB---&gt;|----------------|  __
           |                |    |
           |                |    |
   2 GB---&gt;|                |    |
           |     Tasks      |    |  User Space (Code + Data/Stack)
           |                |    |
   1 GB---&gt;|                |    |
           |                |    |
           |________________|  __| 
 0x00000000
          Kernel/User Linear addresses



            ________________ _____                    
           |Other KernelData|___  |  |                |
           |----------------|   | |__|                |
           |     Kernel     |\  |____|   Real Other   |
  3 GB ---&gt;|----------------| \      |   Kernel Data  |
           |                |\ \     |                |
           |              __|_\_\____|__   Real       |
           |      Tasks     |  \ \   |     Tasks      |
           |              __|___\_\__|__   Space      |
           |                |    \ \ |                |
           |                |     \ \|----------------|
           |                |      \ |Real KernelSpace|
           |________________|       \|________________|

           Logical Addresses          Physical Addresses
</code></pre><p>而这两部分空间的左右是什么呢？怎样才能正确的操作这部分空间呢？（保留原汁原味，不翻译！）</p>
<blockquote>
<p>Kernel space is where the kernel (i.e., the core of the operating system) executes (i.e., runs) and provides its services.</p>
</blockquote>
<blockquote>
<p>User space is that set of memory locations in which user processes (i.e., everything other than the kernel) run. A process is an executing instance of a program. One of the roles of the kernel is to manage individual user processes within this space and to prevent them from interfering with each other.</p>
</blockquote>
<blockquote>
<p>Kernel space can be accessed by user processes only through the use of system calls. System calls are requests in a Unix-like operating system by an active process for a service performed by the kernel, such as input/output (I/O) or process creation. An active process is a process that is currently progressing in the CPU, as contrasted with a process that is waiting for its next turn in the CPU. I/O is any program, operation or device that transfers data to or from a CPU and to or from a peripheral device (such as disk drives, keyboards, mice and printers).</p>
</blockquote>
<h4 id="64-位架构的机器"><a href="#64-位架构的机器" class="headerlink" title="64 位架构的机器"></a>64 位架构的机器</h4><p>对于 64 位架构的机器，其最大内存寻址能力为 17179869184 GiB，足以覆盖目前常见的绝大多数机器装配的内存。故而 Linux kernel 不再区分 Low/High Memory，全部视为 Low Memory。User Space 和 Kernel Space 的 Limit 均相同。现今的内存分页机制其实非常复杂，由于分页层数的不同，导致虚拟地址空间的大小也不同，具体相关描述请查看内核源代码和内核文档。</p>
<p><img src="https://alicdn.kmahyyg.xyz/asset_files/context_02_lvmm_64.svg" alt="Linux Mapper of RAM_x64"></p>
<p>下列的文档可能对你了解这部分内容有所帮助。</p>
<ul>
<li><p><a href="https://en.wikibooks.org/wiki/The_Linux_Kernel/Memory" target="_blank" rel="noopener">https://en.wikibooks.org/wiki/The_Linux_Kernel/Memory</a></p>
</li>
<li><p><a href="https://elixir.bootlin.com/linux/v5.0.6/source/arch/x86/Kconfig#L1356" target="_blank" rel="noopener">https://elixir.bootlin.com/linux/v5.0.6/source/arch/x86/Kconfig#L1356</a></p>
</li>
<li><p><a href="https://elixir.bootlin.com/linux/v5.0.6/source/Documentation/vm/highmem.rst" target="_blank" rel="noopener">https://elixir.bootlin.com/linux/v5.0.6/source/Documentation/vm/highmem.rst</a></p>
</li>
</ul>
<blockquote>
<p>High memory (highmem) is used when the size of physical memory approaches or exceeds the maximum size of virtual memory. At that point it becomes impossible for the kernel to keep all of the available physical memory mapped at all times. This means the kernel needs to start using temporary mappings of the pieces of physical memory that it wants to access.</p>
</blockquote>
<ul>
<li><a href="https://elixir.bootlin.com/linux/v5.0.6/source/Documentation/x86/x86_64/mm.txt" target="_blank" rel="noopener">https://elixir.bootlin.com/linux/v5.0.6/source/Documentation/x86/x86_64/mm.txt</a></li>
</ul>
<blockquote>
<p>Architecture defines a 64-bit virtual address. Implementations can support<br>less. Currently supported are 48- and 57-bit virtual addresses. Bits 63<br>through to the most-significant implemented bit are sign extended.<br>This causes hole between user space and kernel addresses if you interpret them<br>as unsigned.</p>
</blockquote>
<blockquote>
<p>The direct mapping covers all memory in the system up to the highest<br>memory address (this means in some cases it can also include PCI memory<br>holes).</p>
</blockquote>
<h3 id="关于内核空间与内存安全"><a href="#关于内核空间与内存安全" class="headerlink" title="关于内核空间与内存安全"></a>关于内核空间与内存安全</h3><p>那为什么要区分内核空间和用户空间呢？每个进程到底能用到多少的内存呢？</p>
<p>操作系统的核心是系统内核，内核独立于普通的应用程序，可以访问受保护的内存空间、拥有访问底层所有硬件设备的最高权限，保护这部分内存就显得尤为重要。针对 32 位 Linux 操作系统而言，将最高的 1 GiB（从虚拟地址 0xC0000000 到 0xFFFFFFFF ），供内核使用，称为内核空间，而将较低的 3 GiB（从虚拟地址 0x00000000 到 0xBFFFFFFF ），供各个进程使用，称为用户空间。每个进程可以通过系统调用进入内核，因此，Linux 内核由系统内的所有进程共享。于是，从具体进程的角度来看，每个进程可以拥有 4 GiB 的虚拟空间。</p>
<p>内核空间故名思议，存放的是内核代码和数据；而用户空间存放的是用的代码和数据，这两部分空间再次强调，都是保存在 <strong>虚拟内存空间之内</strong> 的。内核的数据需要悉心的保护，确保不被未授权第三方获取，Linux Kernel 使用了两层保护机制，即 Ring 0 和 Ring 3.</p>
<p>用户初始运行一个进程时，运行于 Ring 3（用户态），此时处理器工作在权限最低的 Ring 3, 程序请求提权发出中断信号，进而通过 TRAP 指令调用中断处理程序执行 System Call（系统调用），陷入 Ring 0（内核态）时便拥有了最高权限，执行的内核代码便会调用当前进程的内核栈，每个进程都有自己对应的内核栈。有名的 Rootkit 病毒便大多是提权到 Ring 0 来实现自我保护的。</p>
<h4 id="题外：那-Ring-1-和-Ring-2-呢？"><a href="#题外：那-Ring-1-和-Ring-2-呢？" class="headerlink" title="题外：那 Ring 1 和 Ring 2 呢？"></a>题外：那 Ring 1 和 Ring 2 呢？</h4><p>X86 架构提供了四层分级保护域，Ring 0 到 Ring 3. Ring 0 具有最高权限，Ring 3 权限最低。Ring 1 大多用于加载虚拟化内核和硬件驱动（例如：VirtualBox Guest Kernel），Ring 2 大多用于加载 I/O 设备相关的驱动和一些被保护的函数库(I/O Privileged Code)，早期的 OS/2 的 Presentation Manager 代码便加载到这一层。个人认为，可以简单的理解为 Ring 1 、 Ring 2 和 Ring 0 的差异可以简化视为描述符不同的 Ring 0 层。</p>
<h1 id="上下文-Context"><a href="#上下文-Context" class="headerlink" title="上下文 Context"></a>上下文 Context</h1><h2 id="明确相关概念"><a href="#明确相关概念" class="headerlink" title="明确相关概念"></a>明确相关概念</h2><p>上下文：是从英文 Context 翻译过来，指的是一种环境。相对于进程而言，就是进程执行时的环境；具体来说就是各个变量和数据，包括所有的寄存器变量、进程打开的文件、内存信息等。主要分为中断上下文、进程上下文、原子上下文。</p>
<p>原子： Atom，本意是“不能被进一步分割的最小粒子”，而原子操作 (atomic operation) 意为”不可被中断的一个或一系列操作”。</p>
<p>原子上下文：内核的一个原则是：在处理 IRQ 过程中、以及持有自旋锁 (spin_lock) 的过程中，内核不能访问用户空间，内核不能调用任何引起睡眠的函数。如果一个进程正在处于上述状态之一，且不能被中断，则称该进程正在进行原子操作，该进程此时对应的上下文为原子上下文。</p>
<h3 id="原子上下文"><a href="#原子上下文" class="headerlink" title="原子上下文"></a>原子上下文</h3><p>Linux 提供了以下六个宏来判断是否处于原子上下文的情况： <a href="https://elixir.bootlin.com/linux/v5.0.6/source/include/linux/preempt.h#L87" target="_blank" rel="noopener">include/linux/preempt.h Line 87</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*
 * Are we doing bottom half or hardware interrupt processing?
 *
 * in_irq()       - We're in (hard) IRQ context
 * in_softirq()   - We have BH disabled, or are processing softirqs
 * in_interrupt() - We're in NMI,IRQ,SoftIRQ context or have BH disabled
 * in_serving_softirq() - We're in softirq context
 * in_nmi()       - We're in NMI context
 * in_task()      - We're in task context
 *
 * Note: due to the BH disabled confusion: in_softirq(),in_interrupt() really
 *       should not be used in new code.
 */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> in_irq()        (hardirq_count())</span>
<span class="token macro property">#<span class="token directive keyword">define</span> in_softirq()        (softirq_count())</span>
<span class="token macro property">#<span class="token directive keyword">define</span> in_interrupt()        (irq_count())</span>
<span class="token macro property">#<span class="token directive keyword">define</span> in_serving_softirq()    (softirq_count() &amp; SOFTIRQ_OFFSET)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> in_nmi()        (preempt_count() &amp; NMI_MASK)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> in_task()        (!(preempt_count() &amp; \
                   (NMI_MASK | HARDIRQ_MASK | SOFTIRQ_OFFSET)))</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a href="https://elixir.bootlin.com/linux/v5.0.6/source/include/linux/preempt.h#L142" target="_blank" rel="noopener">include/linux/preempt.h Line 142</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*
 * Are we running in atomic context?  WARNING: this macro cannot
 * always detect atomic context; in particular, it cannot know about
 * held spinlocks in non-preemptible kernels.  Thus it should not be
 * used in the general case to determine whether sleeping is possible.
 * Do not use in_atomic() in driver code.
 */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> in_atomic()    (preempt_count() != 0)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这些宏访问的地方都是： <code>thread_info-&gt;preempt_count</code> 这些中断计数和抢占计数任何地方返回不为 0 均为原子上下文，禁止违反上面说过的原则。令人奇怪的是，<code>in_atomic()</code> 这个宏提示是 unrealiable 的，为什么呢？</p>
<blockquote>
<p>但是，对于 <code>in_atomic()</code> 来说，在启用抢占的情况下，它工作的很好，可以告诉内核目前是否持有自旋锁，是否禁用抢占等。但是，在没有启用抢占的情况下， <code>spin_lock</code> 根本不修改 <code>preempt_count()</code> ，所以即使内核调用了 <code>spin_lock</code> ，持有了自旋锁，<code>in_atomic()</code> 仍然会返回 0，错误的告诉内核目前在非原子上下文中。所以凡是依赖 <code>in_atomic()</code> 来判断是否在原子上下文的代码，在禁止线程抢占的情况下都是不可靠的。具体的显式声明禁止线程抢占由 <code>preempt_disable()</code> 实现。</p>
</blockquote>
<h3 id="关于-Linux-Kernel-的-preempt-count"><a href="#关于-Linux-Kernel-的-preempt-count" class="headerlink" title="关于 Linux Kernel 的 preempt_count"></a>关于 Linux Kernel 的 preempt_count</h3><p><code>preempt_count</code> 是 Linux 的线程抢占计数器，不过多深入，之后讲到线程调度和预防死锁的时候我们会详细介绍。具体的 <code>preempt_count</code> 的内容定义在 Linux 内核源代码的这里可以查到：<a href="https://elixir.bootlin.com/linux/v5.0.6/source/include/linux/preempt.h#L13" target="_blank" rel="noopener">include/linux/preempt.h Line 13</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*
 * We put the hardirq and softirq counter into the preemption
 * counter. The bitmask has the following meaning:
 *
 * - bits 0-7 are the preemption count (max preemption depth: 256)
 * - bits 8-15 are the softirq count (max # of softirqs: 256)
 *
 * The hardirq count could in theory be the same as the number of
 * interrupts in the system, but we run all interrupt handlers with
 * interrupts disabled, so we cannot have nesting interrupts. Though
 * there are a few palaeontologic drivers which reenable interrupts in
 * the handler, so we need more than one bit here.
 *
 *         PREEMPT_MASK:    0x000000ff
 *         SOFTIRQ_MASK:    0x0000ff00
 *         HARDIRQ_MASK:    0x000f0000
 *             NMI_MASK:    0x00100000
 * PREEMPT_NEED_RESCHED:    0x80000000
 */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PREEMPT_BITS    8</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SOFTIRQ_BITS    8</span>
<span class="token macro property">#<span class="token directive keyword">define</span> HARDIRQ_BITS    4</span>
<span class="token macro property">#<span class="token directive keyword">define</span> NMI_BITS    1</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>具体的自己看代码注释吧，懒得过多解释了。</p>
<h2 id="上下文切换简述"><a href="#上下文切换简述" class="headerlink" title="上下文切换简述"></a>上下文切换简述</h2><h3 id="进程上下文"><a href="#进程上下文" class="headerlink" title="进程上下文"></a>进程上下文</h3><p>通过上面的介绍，我们知道处理器总处于下列三种状态的一种：</p>
<ul>
<li>内核态，运行于进程上下文，内核代表进程运行于内核空间。</li>
<li>内核态，运行于中断上下文，内核代表硬件运行于内核空间。</li>
<li>用户态，运行于用户空间。</li>
</ul>
<p>当用户需要请求某个物理设备或系统服务时，就需要通过系统调用使用户程序陷入内核空间后映射对应设备、服务地址到用户空间，才能继续执行。</p>
<p>相对于进程而言，上下文就是进程执行时的环境。当一个进程在执行时, CPU 的所有寄存器中的值、进程的状态以及堆栈中的内容、优先级、调度信息、审计信息、I/O状态、信号与事件信息等等被称为该进程的上下文，是一种对进程执行活动全过程的静态描述。当内核需要切换到另一个进程时，它需要保存当前进程的所有状态，即保存当前进程的上下文，以便在再次执行该进程时，能够必得到切换时的状态执行下去。在 LINUX 中，当前进程上下文均保存在进程的任务数据结构中。在发生中断时，内核就在被中断进程的上下文中，在内核态下执行中断服务例程。但同时会保留所有需要用到的资源，以便中继服务结束时能恢复被中断进程的执行。一个进程的上下文可以分为三个部分:用户级上下文、寄存器上下文以及系统级上下文。</p>
<p>（1）用户级上下文: 正文、数据、用户堆栈以及共享存储区；<br>（2）寄存器上下文: 通用寄存器、程序寄存器(IP)、处理器状态寄存器(EFLAGS)、栈指针(ESP)；<br>（3）系统级上下文: 进程控制块 task_struct、内存管理信息(mm_struct、vm_area_struct、pgd、pte)、内核栈。</p>
<p>当发生进程调度时，进行进程切换就是上下文切换(context switch). 操作系统必须对上面提到的全部信息进行切换，新调度的进程才能运行。而系统调用进行的模式切换(mode switch)。模式切换与进程切换比较起来，容易很多，而且节省时间，因为模式切换最主要的任务只是切换进程寄存器上下文的切换。进程上下文主要保存的内容是异常处理程序与内核线程，在进程上下文中引用 current 是有意义的。上下文切换的一个活动流程是：</p>
<ul>
<li>挂起一个进程，将这个进程在 CPU 中的状态（上下文）存储于内存中的某处，</li>
<li>在内存中检索下一个进程的上下文并将其在 CPU 的寄存器中恢复</li>
<li>跳转到程序计数器所指向的位置（即跳转到进程被中断时的代码行），以恢复该进程</li>
</ul>
<p>由于需要访问 Process Table (Maintained by Kernel)，故 Context Switch 能且仅能在 内核中 进行。</p>
<h3 id="中断上下文"><a href="#中断上下文" class="headerlink" title="中断上下文"></a>中断上下文</h3><p>硬件通过触发信号，导致内核调用中断处理程序，进入内核空间。这个过程中，硬件的一些变量和参数也要传递给内核，内核通过这些参数进行中断处理。所谓的 “中断上下文” ，其实也可以看作就是硬件传递过来的这些参数和内核需要保存的一些其他环境（主要是当前被打断执行的进程环境）。这样的一个中断信号的发生是 random 的，中断处理和软中断无法预测何时发生、什么设备（进程）触发了这个中断，这样的一种中断，引用 current 可以，但没有意义。而中断时，内核不代表任何进程运行，它一般只访问系统空间，而不会访问进程空间，内核在中断上下文中执行时一般不会阻塞。</p>
<p>中断上下文是原子上下文的一部分，禁止被抢占，内核禁止其在中断上下文中执行下列操作：</p>
<ul>
<li>占用互斥体</li>
<li>进入睡眠</li>
<li>执行耗时长的任务</li>
<li>访问用户空间</li>
<li>不允许中断处理例程被递归或并行调用</li>
<li>中断处理例程 <strong>可以被更高级别 IRQ 中断</strong></li>
</ul>
<p>常见的一个例子是：A 进程期待一个 I/O 写完成中断，实际在 B 进程执行、A 进程睡眠时发生。此时的中断信号打断 B 进程，唤醒 A 进程。</p>
<h2 id="Linux-Kernel-的上下文切换-context-switch-实现"><a href="#Linux-Kernel-的上下文切换-context-switch-实现" class="headerlink" title="Linux Kernel 的上下文切换 context_switch 实现"></a>Linux Kernel 的上下文切换 context_switch 实现</h2><p>Linux Kernel 的上下文切换需要详细了解 Linux 内核调度器，迫于时间压力，先暂时把内核源码放在这里，有时间的话在慢慢深究。</p>
<p><a href="https://elixir.bootlin.com/linux/v5.0.6/source/kernel/sched/core.c#L2859" target="_blank" rel="noopener">kernel/sched/core.c Line 2859: context_switch</a></p>
<p><a href="https://elixir.bootlin.com/linux/latest/source/include/linux/sched.h" target="_blank" rel="noopener">include/linux/sched.h Line 72: task_struct</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h4 id="各类博客"><a href="#各类博客" class="headerlink" title="各类博客"></a>各类博客</h4><p><a href="https://www.cnblogs.com/openix/archive/2013/03/09/2952057.html" target="_blank" rel="noopener">https://www.cnblogs.com/openix/archive/2013/03/09/2952057.html</a><br><a href="https://www.21qa.net/questions/167/167" target="_blank" rel="noopener">https://www.21qa.net/questions/167/167</a><br><a href="http://www.cnblogs.com/Anker/p/3269106.html" target="_blank" rel="noopener">http://www.cnblogs.com/Anker/p/3269106.html</a><br><a href="https://blog.csdn.net/zqixiao_09/article/details/50877756" target="_blank" rel="noopener">https://blog.csdn.net/zqixiao_09/article/details/50877756</a><br><a href="https://blog.csdn.net/gatieme/article/details/51872659" target="_blank" rel="noopener">https://blog.csdn.net/gatieme/article/details/51872659</a><br><a href="http://blog.sungju.org/2015/11/17/whats-virtual-address-limit-of-32bit64bit-linux-kernel-2/" target="_blank" rel="noopener">http://blog.sungju.org/2015/11/17/whats-virtual-address-limit-of-32bit64bit-linux-kernel-2/</a><br><a href="http://compgroups.net/comp.lang.asm.x86/privilege-levels-1-and-2/162524" target="_blank" rel="noopener">http://compgroups.net/comp.lang.asm.x86/privilege-levels-1-and-2/162524</a><br><a href="https://blog.csdn.net/baidu_17062867/article/details/37744863" target="_blank" rel="noopener">https://blog.csdn.net/baidu_17062867/article/details/37744863</a></p>
<h4 id="专业的问答网站和第三方文档"><a href="#专业的问答网站和第三方文档" class="headerlink" title="专业的问答网站和第三方文档"></a>专业的问答网站和第三方文档</h4><p><a href="https://linux-kernel-labs.github.io" target="_blank" rel="noopener">https://linux-kernel-labs.github.io</a><br><a href="https://stackoverflow.com/questions/19349572/why-do-we-need-virtual-memory" target="_blank" rel="noopener">https://stackoverflow.com/questions/19349572/why-do-we-need-virtual-memory</a><br><a href="https://en.wikipedia.org/wiki/Virtual_memory" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Virtual_memory</a><br><a href="https://support.symantec.com/en_US/article.TECH244351.html" target="_blank" rel="noopener">https://support.symantec.com/en_US/article.TECH244351.html</a><br><a href="https://en.wikibooks.org/wiki/The_Linux_Kernel/Memory" target="_blank" rel="noopener">https://en.wikibooks.org/wiki/The_Linux_Kernel/Memory</a><br><a href="http://tldp.org/HOWTO/KernelAnalysis-HOWTO-7.html" target="_blank" rel="noopener">http://tldp.org/HOWTO/KernelAnalysis-HOWTO-7.html</a><br><a href="https://stackoverflow.com/questions/6710040/cpu-privilege-rings-why-rings-1-and-2-arent-used" target="_blank" rel="noopener">https://stackoverflow.com/questions/6710040/cpu-privilege-rings-why-rings-1-and-2-arent-used</a><br><a href="https://unix.stackexchange.com/questions/87625/what-is-difference-between-user-space-and-kernel-space" target="_blank" rel="noopener">https://unix.stackexchange.com/questions/87625/what-is-difference-between-user-space-and-kernel-space</a><br><a href="https://en.wikipedia.org/wiki/Context_switch" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Context_switch</a><br><a href="https://www.quora.com/Does-context-switching-happen-in-the-the-kernel-mode" target="_blank" rel="noopener">https://www.quora.com/Does-context-switching-happen-in-the-the-kernel-mode</a></p>
<h4 id="Linux-内核源代码"><a href="#Linux-内核源代码" class="headerlink" title="Linux 内核源代码"></a>Linux 内核源代码</h4><p><a href="https://elixir.bootlin.com/linux/v5.0.6/source" target="_blank" rel="noopener">https://elixir.bootlin.com/linux/v5.0.6/source</a></p>
<p>引用的图片和文字版权归原作者所有</p>

        
                <blockquote style="margin: 2em 0 0;padding: 0.5em 1em;border-left: 3px solid #F44336;background-color: #F5F5F5;list-style: none;">
                    <p><strong>
                         
                            本博客所有文章，未经特殊说明，均使用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" target="_blank">CC BY-NC-SA 3.0 Unported License 授权</a>
                        </strong>
                        <br>
                        <strong>本文链接：</strong><a href="https://www.kmahyyg.xyz/2019/os-process-context/">https://www.kmahyyg.xyz/2019/os-process-context/</a>
                    </p>
                </blockquote>
        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
    <!-- 使用 DISQUS_CLICK -->
<div id="disqus-comment">
    <div id="disqus_thread"></div>

<!-- add animation -->
<style>
	.disqus_click_btn {
            line-height: 30px;
            margin: 0;
            min-width: 50px;
            padding: 0 14px;
            display: inline-block;
            font-family: "Roboto", "Helvetica", "Arial", sans-serif;
            font-size: 14px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0;
            overflow: hidden;
            will-change: box-shadow;
            transition: box-shadow .2s cubic-bezier(.4, 0, 1, 1), background-color .2s cubic-bezier(.4, 0, .2, 1), color .2s cubic-bezier(.4, 0, .2, 1);
            outline: 0;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            vertical-align: middle;
            border: 0;
            background: rgba(158, 158, 158, .2);
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, .14), 0 3px 1px -2px rgba(0, 0, 0, .2), 0 1px 5px 0 rgba(0, 0, 0, .12);
            color: #fff;
            background-color: #757575;
            text-shadow: 0;
            display: none
        }
</style>
	
<div class="btn_click_load"> 
    <button class="disqus_click_btn">阅读评论（请确保 disqus 可以正常加载）</button>
</div>

<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'https://www.kmahyyg.xyz/2019/os-process-context/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'https://www.kmahyyg.xyz/2019/os-process-context/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>

<script type="text/ls-javascript" id="disqus-lazy-load-script">
    $.ajax({
        url: 'https://disqus.com/next/config.json',
        timeout: 4000,
        type: 'GET',
        success: (function() {
            var d = document;
            var s = d.createElement('script');
            s.src = '//kmahyyg.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
            $('.disqus_click_btn').css('display','none');
        })(),
        error: function() {
          $('.disqus_click_btn').css('display','block');
        }
    });
    $('.btn_click_load').click(function() {  //click to load comments
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document;
            var s = d.createElement('script');
            s.src = '//kmahyyg.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
        })();
        $('.disqus_click_btn').css('display','none');
    });
</script>
  	

</div>
<style>
    #disqus-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>

                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2019/Java-BigintArray/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2019/os-fsm/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="https://alicdn.kmahyyg.xyz/asset_files/avatar-yyg.jpg" alt="Patrick Young's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        mailto://i@kmahyyg.xyz
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="mailto://i@kmahyyg.xyz" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2019/04/">四月 2019<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2019/03/">三月 2019<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2019/02/">二月 2019<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2019/01/">一月 2019<span class="sidebar_archives-count">13</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/12/">十二月 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/11/">十一月 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/10/">十月 2018<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/09/">九月 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/08/">八月 2018<span class="sidebar_archives-count">8</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/07/">七月 2018<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/06/">六月 2018<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/05/">五月 2018<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/04/">四月 2018<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/02/">二月 2018<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/12/">十二月 2017<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/11/">十一月 2017<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/10/">十月 2017<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/09/">九月 2017<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/08/">八月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/07/">七月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/06/">六月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/04/">四月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/01/">一月 2017<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/12/">十二月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/10/">十月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/09/">九月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/08/">八月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/07/">七月 2016<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/06/">六月 2016<span class="sidebar_archives-count">6</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    
        <li>
            <a href="/about" title="About">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                About
            </a>
        </li>
        
    
        <li>
            <a href="/tags" title="Tags">
                
                    <i class="material-icons sidebar-material-icons">book</i>
                
                Tags
            </a>
        </li>
        
            <li class="divider"></li>
        
    
        <li>
            <a href="/timeline" title="Timeline">
                
                    <i class="material-icons sidebar-material-icons">timeline</i>
                
                Timeline
            </a>
        </li>
        
    
        <li>
            <a href="/express" title="Express">
                
                    <i class="material-icons sidebar-material-icons">mail</i>
                
                Express
            </a>
        </li>
        
    
        <li>
            <a href="/archlinux" title="ArchLinux">
                
                    <i class="material-icons sidebar-material-icons">local_convenience_store</i>
                
                ArchLinux
            </a>
        </li>
        
    
        <li>
            <a href="/donate" title="Donate">
                
                    <i class="material-icons sidebar-material-icons">account_balance_wallet</i>
                
                Donate
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">92</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/potatoonline" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-twitter">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    

    <!-- Google + -->
    
        <a href="https://plus.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-gplus">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="httpg://github.com/kmahyyg" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
        <a href="https://t.me/ecdsa_sha2_nistp256" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-telegram">
                <span class="visuallyhidden">Telegram</span>
            </button><!--
     --></a>
    

    <!-- V2EX -->
    
        <a href="https://www.v2ex.com/member/kmahyyg" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-v2ex">
                <span class="visuallyhidden">V2EX</span>
            </button><!--
     --></a>
    

    <!-- Segmentfault -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;<span year></span>&nbsp;Potato Online
            
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source/js/lazyload.min.js", true)</script>



    <script>lsloader.load("js_js","https://cdn.jsdelivr.net/gh/viosey/hexo-theme-material@1.5.6/source/js/js.min.js", true)</script>



    <script>lsloader.load("np_js","https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>









   <!-- 使用 DISQUS js 代码 -->






<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Import prettify js  -->

    
        
            <script>lsloader.load("prettify_js","https://cdn.jsdelivr.net/npm/code-prettify@0.1.0/src/prettify.min.js", true)</script>
        
    



<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
        
            $(function() {
                $('pre').addClass('prettyprint linenums').attr('style', 'overflow:auto;');
                prettyPrint();
                })
        
    
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    var copyrightNow = new Date().getFullYear();
    var textContent = document.querySelector('span[year]')

    copyrightSince = 2015;
    if (copyrightSince === copyrightNow||copyrightSince === 0000) {
        textContent.textContent = copyrightNow
    } else {
        textContent.textContent = copyrightSince + ' - ' + copyrightNow
    }

    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.6 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
