<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>OSCP Prepare - Fuck GFW &middot; Pat~ Pat~ Meow~</title>
  <meta name="description" content="使用 GCP 构建一个 Kali 工作平台并配置本地快速访问" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://www.kmahyyg.xyz/css/main.min.css" />
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-123948588-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  <style>
    body {
      background: #ecedef url("https://alicdn.kmahyyg.xyz/asset_files/aether/bgimg.webp") repeat;
    }
  </style>
</head>
  <body class="single-body">
    <nav class="nav-bar side-padding">
  <h1 class="nav-header"><a href="https://www.kmahyyg.xyz/" class="nav-text">Patrick Young</a></h1>
  <div class="hamburger-menu">
    <button onclick="hamburgerMenuPressed.call(this)" aria-haspopup="true" aria-expanded="false" aria-controls="menu" aria-label="Menu">
      <span></span>
      <span></span>
    </button>
    <ul id="menu" class="hamburger-menu-overlay">
      <li><a href="https://www.kmahyyg.xyz/" class="hamburger-menu-overlay-link">Home</a></li>
      <li><a href="https://www.kmahyyg.xyz/express-page/" class="hamburger-menu-overlay-link">Express Inc</a></li>
      <li><a href="https://www.kmahyyg.xyz/about-me-page/" class="hamburger-menu-overlay-link">About</a></li>
      <li><a href="https://www.kmahyyg.xyz/archlinux-bug-page/" class="hamburger-menu-overlay-link">Arch Linux</a></li>
      <li><a href="https://www.kmahyyg.xyz/donate-page/" class="hamburger-menu-overlay-link">Donate</a></li>
      <li><a href="https://www.kmahyyg.xyz/categories/code" class="hamburger-menu-overlay-link">Code</a></li><li><a href="https://www.kmahyyg.xyz/categories/life" class="hamburger-menu-overlay-link">Life</a></li><li><a href="https://www.kmahyyg.xyz/categories/network" class="hamburger-menu-overlay-link">Network</a></li><li><a href="https://www.kmahyyg.xyz/categories/school" class="hamburger-menu-overlay-link">School</a></li><li><a href="https://www.kmahyyg.xyz/categories/tech" class="hamburger-menu-overlay-link">Tech</a></li>
    </ul>
  </div>
</nav>
    <main class="content side-text-padding">
      <article class="post ">
        <header class="post-header">
        	<h1 class="post-title">OSCP Prepare - Fuck GFW</h1>
          <p class="post-date">Posted <time datetime="2019-06-18">Jun 18, 2019</time></p>
        </header>
        
        <picture class="post-figure">
            
            <source srcset="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_network.webp">
          <img src="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_network.webp" >
        </picture>
        
        

<h1 id="preface">Preface</h1>

<p>Due to the fucking GFW, I cannot access to the OSCP lab very smoothly without some software. So I&rsquo;d like to build my working environment in Google Cloud. This article is going to introduce you how to deploy latest Kali Linux and accelarate remote desktop access in your own laptop.</p>

<p>DO NOT UPLOAD A HUGE IMAGE FILE (whether in raw or vmdk) SINCE THE POOR NETWORK IN CHINA MAINLAND.</p>

<h2 id="prerequisite">Prerequisite</h2>

<ul>
<li>A Network Accarlarator: ShadowsocksR with your own well-deployed server</li>
</ul>

<p>Here, I assume your client listening at 127.0.0.1:1084 on your laptop.</p>

<ul>
<li>A Google Cloud Platform Account</li>
<li>A laptop installed with Linux OS (here, I use Arch Linux :)</li>
</ul>

<h1 id="gcp-install-kali-with-netboot">GCP - install Kali with netboot</h1>

<h2 id="prepare-custom-image">Prepare custom image</h2>

<p>Firstly, create a storage bucket in your console and open a cloud shell window.
Your storage bucket should give access to your service account inside your GCP project and also YOU NEED TO manually give full access to your own gmail account.</p>

<p>Next, download the tar.gz file from <a href="https://boot.netboot.xyz/ipxe/netboot.xyz-gce.tar.gz">here</a>, and rename it to <code>kali-gce.tar.gz</code> (Lowercase letters with numeric chars and hyphen are allowed). Upload it to your bucket.</p>

<p>In your cloud shell, Run:</p>

<pre><code class="language-bash">$ gcloud compute images create kali-gce --source-uri gs://&lt;YOUR BUCKET NAME&gt;/kali-gce.tar.gz
</code></pre>

<h2 id="create-instance">Create instance</h2>

<p>Then you have a custom image, then create an instance with 40GiB persistent disk with the image we just created. After you created, halt this instance and enable the console access, Restart your machine and access its console via cloudshell.</p>

<h2 id="install-os">Install OS</h2>

<p>Choose &ldquo;Security related&rdquo; Menu, and select Kali. Follow the stey-by-step wizard.
You have some points you must notice here:</p>

<ul>
<li>The network must be configured manually, for network configuration in detail, check the VPC network tab in your web console. The Netmask is 255.255.240.0, The IP should be your internal IP.</li>
<li>The debian archive address must be input manually, using &ldquo;<a href="http://http.kali.org&quot;">http://http.kali.org&quot;</a>, the archive root folder is &ldquo;/&rdquo;.</li>
<li>The partition step, I suggest you divide 25 GiB to /, and 15GiB to individual /home.</li>
<li>The component part, make sure you choose &ldquo;Web Server&rdquo; and &ldquo;SSH Server&rdquo;. I suggest you use XFCE (lightweight enough)or don&rsquo;t install any DE.</li>
</ul>

<p>We&rsquo;ll use XFCE as an example here.</p>

<h2 id="after-installation-configure">After-Installation configure</h2>

<p>Firstly, set a root password and copy your SSH public key to your instance.</p>

<p>Secondly, do the necessary secure enhancement.</p>

<blockquote>
<p>I tried to use VNC, since it&rsquo;s very slow and in a low-quality, also it&rsquo;s difficult to configure.</p>
</blockquote>

<p>You just have the base installation.</p>

<p>Run the following commands to get all the packages we need.</p>

<pre><code class="language-bash">$ sudo apt update -y
$ sudo apt install kali-linux-full kali-linux-web kali-linux-forensic kali-linux-pwtools -y
$ sudo apt install x2goserver x2goserver-extensions tmux -y
$ sudo systemctl enable ssh
$ sudo systemctl start ssh
$ sudo x2godbadmin --createdb
$ rm -rf /usr/share/applications/applications # IF FOUND DUPLICATE ENTRIES IN YOUR START MENU
$ sudo systemctl start x2goserver
$ sudo systemctl enable x2goserver
</code></pre>

<p>Please update the following settings in your <code>/etc/ssh/sshd_config</code>:</p>

<pre><code>AllowAgentForwarding no
AllowTcpForwarding yes
GatewayPorts yes
X11Forwarding yes
X11DisplayOffset 10
X11UseLocalhost yes
PermitTTY yes
PrintMotd no
TCPKeepAlive yes
Compression delayed
UseDNS no
PermitTunnel yes
</code></pre>

<p>That&rsquo;s all, enjoy it.</p>

<h1 id="laptop-redsocks-transparent-proxy">Laptop - redsocks transparent proxy</h1>

<h2 id="prerequisite-1">Prerequisite</h2>

<ul>
<li>iptables enabled</li>
<li>Enable packet forward in kernel parameter</li>
</ul>

<p>Write the following contents to your <code>/etc/sysctl.d/99-forward_allow.conf</code> :</p>

<pre><code>net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1
</code></pre>

<p>Then <code>sysctl -p /etc/sysctl.d/99-forward_allow.conf</code></p>

<ul>
<li><code>pacman -S redsocks x2goclient</code></li>
<li>Configured SSH Agent</li>
</ul>

<h2 id="local-x2go-configure">Local x2go configure</h2>

<p>Create a session with your config since the data of x2go is transferred via SSH. Set the screen resolutions and DPI. Set connection speed to WAN, enable Try auto login via SSH Agent and make sure your session type is corresponding to your DE.</p>

<h2 id="local-redsocks-configure">Local redsocks configure</h2>

<p>You should configure all of the below in root permission.</p>

<p>I assume that you would like to put your config in <code>/etc/redsocks/</code>.</p>

<p>Copy the following content to <code>/etc/redsocks/redsocks.service</code>:</p>

<pre><code class="language-systemd">[Unit]
Description=Transparent redirector of any TCP connection to proxy using your firewall

[Service]
Type=forking
PIDFile=/run/redsocks.pid
EnvironmentFile=/etc/conf.d/redsocks
User=root
ExecStartPre=/usr/bin/redsocks -t -c $REDSOCKS_CONF
ExecStartPre=/etc/redsocks/iptables_conf.sh a
ExecStart=/usr/bin/redsocks -c $REDSOCKS_CONF \
  -p /run/redsocks.pid
ExecStopPost=/bin/rm /run/redsocks.pid
ExecStopPost=/etc/redsocks/iptables_conf.sh d
Restart=on-abort

[Install]
WantedBy=multi-user.target
</code></pre>

<p>Set the correct environment for service, <code>/etc/conf.d/redsocks</code>:</p>

<pre><code class="language-bash">REDSOCKS_CONF=&quot;/etc/redsocks/redsocks.conf&quot;
</code></pre>

<p>Create a script to help you persistent your iptables config and <code>chmod +x iptables_conf.sh</code>, <code>/etc/redsocks/iptables_conf.sh</code>:</p>

<pre><code class="language-bash">#!/bin/sh
case $1 in
        'a')
                # Create chains
                iptables -t nat -N REDSOCKS
                # Ignore the private network IP
                iptables -t nat -A REDSOCKS -d 10.0.0.0/8 -j RETURN
                iptables -t nat -A REDSOCKS -d 127.0.0.0/8 -j RETURN
                iptables -t nat -A REDSOCKS -d 169.254.0.0/16 -j RETURN
                iptables -t nat -A REDSOCKS -d 172.16.0.0/12 -j RETURN
                iptables -t nat -A REDSOCKS -d 192.168.0.0/16 -j RETURN
                iptables -t nat -A REDSOCKS -d 224.0.0.0/4 -j RETURN
                iptables -t nat -A REDSOCKS -d 240.0.0.0/4 -j RETURN
                # Only redirect Google Cloud IP
                iptables -t nat -A REDSOCKS -d 34.92.0.0/14 -p tcp -j REDIRECT --to-ports 11088
                # The 11088 is the configured port in your redsocks config, 34.92.0.0/14 is your Google Cloud machine IP address range
                # For all connectiont towards 22, redirect to redsocks chain.
                iptables -t nat -A OUTPUT -p tcp --dport 22 -j REDSOCKS
        ;;
        'd')
                # Clean up after service stop
                iptables -t nat -F REDSOCKS
                iptables -t nat -X REDSOCKS
        ;;
esac
</code></pre>

<p>Redsocks config, for just redirecting all TCP (Not UDP, write your own config if you need, UDP proxy only support for SOCKS5), <code>/etc/redsocks/redsocks.conf</code>:</p>

<pre><code class="language-yaml">base {
        // debug: connection progress
        log_debug = off;
        // info: start and end of client session
        log_info = on;
        log = &quot;syslog:daemon&quot;;
        daemon = yes;
        redirector = iptables;
}

redsocks {
        /* `local_ip' defaults to 127.0.0.1 for security reasons,
         * use 0.0.0.0 if you want to listen on every interface.
         * `local_*' are used as port to redirect to.
         */
        local_ip = 127.0.0.1;
        local_port = 11088;

        // Enable or disable faster data pump based on splice(2) syscall.
        // Default value depends on your kernel version, true for 2.6.27.13+
        // splice = false;
        
        // `ip' and `port' are IP and tcp-port of proxy-server
        // You can also use hostname instead of IP, only one (random)
        // address of multihomed host will be used.
        ip = 127.0.0.1;
        port = 1084;
        // known types: socks4, socks5, http-connect, http-relay
        type = socks5;
        disclose_src = false;
        on_proxy_fail = close;
}
</code></pre>

<p>That&rsquo;s all, enjoy it. If you need to redirect UDP packets, check the default config example in <code>/usr/share/redsocks/redsocks.conf.example</code>, the docs is in <code>/usr/share/doc/redsocks/README.md</code>, and the example service is <code>/usr/share/redsocks/redsocks.service</code>.</p>

<p>(FINISHED!)</p>

<h1 id="referrence">Referrence</h1>

<ol>
<li><a href="https://wiki.archlinux.org/index.php/TigerVNC">https://wiki.archlinux.org/index.php/TigerVNC</a>   VNC IS REALLY GARBAGE!</li>
<li><a href="https://netboot.xyz/providers/gce/">https://netboot.xyz/providers/gce/</a></li>
<li><a href="https://wiki.archlinux.org/index.php/iptables">https://wiki.archlinux.org/index.php/iptables</a></li>
<li><a href="https://linuxaria.com/article/redirect-all-tcp-traffic-through-transparent-socks5-proxy-in-linux#targetText=Redirect%20all%20(TCP)%20traffic%20through%20transparent%20socks5%20proxy%20in%20Linux&amp;targetText=SOCKet%20Secure%20(SOCKS)%20is%20an,users%20may%20access%20a%20server">https://linuxaria.com/article/redirect-all-tcp-traffic-through-transparent-socks5-proxy-in-linux#targetText=Redirect%20all%20(TCP)%20traffic%20through%20transparent%20socks5%20proxy%20in%20Linux&amp;targetText=SOCKet%20Secure%20(SOCKS)%20is%20an,users%20may%20access%20a%20server</a>.</li>
<li><a href="https://wiki.archlinux.org/index.php/X2Go">https://wiki.archlinux.org/index.php/X2Go</a></li>
</ol>

      </article>
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "kmahyyg" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </main>
    <nav class="end-nav side-padding">
      
      <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="https://www.kmahyyg.xyz/tech/glibc-v4preferred/" class="card blog-card" rel="bookmark" >
    
    <div class="card-img-container">
      <p class="card-img-overlay">Next Article</p>
      <picture>
        
        <source srcset="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_network.webp">
        <img src="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_network.webp" class="card-img" >
      </picture>
    </div>
    
  <article class="card-body">
    <h2 class="card-title">对指定域名的解析 IPv4 结果优先</h2>
    <p class="card-text">对 GLIBC getaddrinfo 函数进行配置，A 记录优先级高于 AAAA 记录</p>
    <div class="card-subtext muted-text">
      <p>Posted <time datetime="2019-06-05 65:00">Jun 5, 2019</time></p>
      <p>#network </p>
    </div>
  </article>
</a>
      
      <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="https://www.kmahyyg.xyz/" class="card home-card" style="background-image: url( https://alicdn.kmahyyg.xyz/asset_files/aether/backtohome.webp )" rel="bookmark" >
  Home
</a>
    </nav>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>
<script src="https://www.kmahyyg.xyz/js/core.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
  </body>
</html>