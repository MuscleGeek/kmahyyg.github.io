<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>关于 C 的 CRC32 实现 &middot; Pat~ Pat~ Meow~</title>
  <meta name="description" content="CRC32 是数据包校验的一个重要算法，本文主要记录作者的一些思考。" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://www.kmahyyg.xyz/css/main.min.css" />
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-123948588-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  <style>
    body {
      background: #ecedef url("https://alicdn.kmahyyg.xyz/asset_files/aether/bgimg.webp") repeat;
    }
  </style>
</head>
  <body class="single-body">
    <nav class="nav-bar side-padding">
  <h1 class="nav-header"><a href="https://www.kmahyyg.xyz/" class="nav-text">Patrick Young</a></h1>
  <div class="hamburger-menu">
    <button onclick="hamburgerMenuPressed.call(this)" aria-haspopup="true" aria-expanded="false" aria-controls="menu" aria-label="Menu">
      <span></span>
      <span></span>
    </button>
    <ul id="menu" class="hamburger-menu-overlay">
      <li><a href="https://www.kmahyyg.xyz/" class="hamburger-menu-overlay-link">Home</a></li>
      <li><a href="https://www.kmahyyg.xyz/express-page/" class="hamburger-menu-overlay-link">Express Inc</a></li>
      <li><a href="https://www.kmahyyg.xyz/about-me-page/" class="hamburger-menu-overlay-link">About</a></li>
      <li><a href="https://www.kmahyyg.xyz/archlinux-bug-page/" class="hamburger-menu-overlay-link">Arch Linux</a></li>
      <li><a href="https://www.kmahyyg.xyz/donate-page/" class="hamburger-menu-overlay-link">Donate</a></li>
      <li><a href="https://www.kmahyyg.xyz/categories/code" class="hamburger-menu-overlay-link">Code</a></li><li><a href="https://www.kmahyyg.xyz/categories/life" class="hamburger-menu-overlay-link">Life</a></li><li><a href="https://www.kmahyyg.xyz/categories/network" class="hamburger-menu-overlay-link">Network</a></li><li><a href="https://www.kmahyyg.xyz/categories/school" class="hamburger-menu-overlay-link">School</a></li><li><a href="https://www.kmahyyg.xyz/categories/tech" class="hamburger-menu-overlay-link">Tech</a></li>
    </ul>
  </div>
</nav>
    <main class="content side-text-padding">
      <article class="post ">
        <header class="post-header">
        	<h1 class="post-title">关于 C 的 CRC32 实现</h1>
          <p class="post-date">Posted <time datetime="2018-12-04">Dec 4, 2018</time></p>
        </header>
        
        <picture class="post-figure">
            
            <source srcset="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_code.webp">
          <img src="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_code.webp" >
        </picture>
        
        

<h1 id="preface">Preface</h1>

<p>最近讲了计算机网络课程，在上课过程中明白了 CRC32 的人工计算方法。个人猜测后面计算机网络实验会做，趁最近忙碌，一鼓作气，在刚刚学完的时候一起实现了吧。</p>

<h2 id="关于-crc32">关于 CRC32</h2>

<p>具体的原理性的东西就不说了，大家自己搜索 IEEE 802.3 相关文档和维基百科吧。主要用途是传输过程中的错误检测，由于容错率高，简单易于实现，占用资源少，得到了广泛的应用。</p>

<h3 id="关于-手动计算">关于 手动计算</h3>

<p>就那点内容，其实我也很懵逼，就多查查资料吧。剩下的就是 <code>Talk is cheap, show me the code!</code> ，大家自己根据 Reversed CRC32 的 GZip 实现参考吧。</p>

<pre><code class="language-cpp">// C Native implement, CRC32

// Reference: RFC1952 https://tools.ietf.org/html/rfc1952
// Reference: PEDIY https://bbs.pediy.com/thread-17195.htm
// Reference: CSDN https://blog.csdn.net/xiaogugood/article/details/8724745
// Reference: https://stackoverflow.com/questions/2587766/how-is-a-crc32-checksum-calculated
// Reference: http://stigge.org/martin/pub/SAR-PR-2006-05.pdf

// Written by Patrick Young
// Created on Tuesday, December 11, 2018 2:57 PM
// Updated on Wednesday, December 12, 2018 1:06 PM
// Rev.5

/*
 * The highest bit of the generator is always 1, so ignored in the polyabbr.
 *
 * Algorithm   Result   	Check      	     Poly        Init       RefIn 	RefOut 	XorOut      ReversedPoly
    CRC-32	 0xCBF43926	  0xCBF43926	0x04C11DB7	  0xFFFFFFFF	true	true	0xFFFFFFFF   0xEDB88320
 */

#include &lt;stdio.h&gt;
#include &lt;inttypes.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;

unsigned long crc_table[256];  // Table of CRCs of all 8-bit messages
int is_crc_table_computed = 0;

//计算本字节后的CRC码，等于上一字节余式CRC码的低8位左移8位，加上上一字节CRC右移8位和本字节之和后所求得的CRC码
void make_crc_table(void){
    unsigned long c;
    for (int n = 0; n &lt; 256; ++n) {
        // all groups contains 8 bits * 4 * n, XOR can be passed without any external opeation
        // divide the msg into 8-bit-long group
        c = (unsigned long) n;
        for (int k = 0; k &lt; 8; ++k) {
            if (c &amp; 1){
                // Least-Significant-Bit first.
                // Same CRC property but reversed to fit old hardware(low memory address save lower bits of data.)
                c= 0xedb88320L ^ (c &gt;&gt; 1);  // 0 is non-sense.
            } else {
                c= c &gt;&gt; 1;
            }
        }
        crc_table[n] = c;
    }
    is_crc_table_computed = 1;
}

/*
 * Update a running crc with the bytes buf[0..len-1] and return
the updated crc. The crc should be initialized to zero. Pre- and
post-conditioning (one's complement) is performed within this
function so it shouldn't be done by the caller. Usage example:
 *
 *  unsigned long crc = 0L;
 *
 *  while (read_buffer(buffer, length) != EOF) {
 *      crc = update_crc(crc, buffer, length);
 *  }
 *   if (crc != original_crc) error();
 *
*/

unsigned long update_crc(unsigned long crc, unsigned char *buf, int len){
    unsigned long c = crc ^ 0xffffffffL;

    if (!is_crc_table_computed){
        make_crc_table();    // build the crc table first for fast lookup
    }
    /*
    （1）将上次计算出的CRC校验码右移一个字节；
    （2）将移出的这个字节与新的要校验的字节进行XOR运算；
    （3）用运算出的值在预先生成码表中进行索引，获取对应的值（称为余式）；
    （4）用获取的值与第（1）步右移后的值进行XOR运算；
    （5）如果要校验的数据已经处理完，则第（4）步的结果就是最终的CRC校验码。如果还有数据要进行处理，则再转到第（1）步运行。
     */
    for (int p = 0; p &lt; len; ++p) {
        c = crc_table[(c ^ buf[p]) &amp; 0xff] ^ (c &gt;&gt;8);
        // remove the non-sense zero and shifted bits
    }
    return c ^ 0xffffffffL;
    // avoid &quot;add zero as you want, not affected&quot; problem
}

unsigned long crc(unsigned char *buf, int len){
    // Math theory by hand: (quotient + remainder)/divisor = 0
    // appended 0s is used for be a placeholder of remainder
    return update_crc(0L,buf,len);      // recursive update crc checksum.
}

int check_crcsum(unsigned char *src, unsigned long sum){
    // why should I calculate the damn divide
    // (data+crc) / divisor = 000 ,correct
    unsigned long xr = crc(src,(int)strlen(src));
    // just calculate received data's CRC, check if corresponding is okay.
    printf(&quot;The source is %s, Checksum calculated is: 0x%lx\n&quot;, src, xr);
    if (xr == sum){
        printf(&quot;Data CRC check passed! \n\n&quot;);
        return 0;
    }
    else {
        printf(&quot;The offered checksum 0x%lx is different from offered one. \n&quot;,sum);
        printf(&quot;Data Corrupted! \n&quot;);
        return 1;
    }
}

void printUsage(char *argv[]){
    printf(&quot;Illegal input! \n&quot;);
    printf(&quot;Usage: %s &lt;SOURCE STRING&gt; 0x&lt;CRC32SUM&gt;\n&quot;,argv[0]);
    printf(&quot;Usage: If you want to calculate, just input source in ASCII mode. \n&quot;);
    printf(&quot;Usage: If you want to check, use the second param such as 1A3C5D78 as a HEX String.\n\n&quot;);
}

int main(int argc, char* argv[]){
    if (argc != 2 &amp;&amp; argc !=3) {
        printUsage(argv);
        return -1;
    } else if (argc == 2){
        char *ipt = argv[1];
        unsigned long final = crc(ipt,(int)strlen(ipt));
        printf(&quot;The source is: %s\n&quot;,ipt);
        printf(&quot;The CRC32 checksum is: 0x%lx \n\n&quot;,final);
        return 0;
    } else if (argc == 3){
        char *ipt = argv[1];
        char *csum = argv[2];
        if (strlen(csum) != 8){
            printUsage(argv);
            return -1;
        }
        unsigned long hexcsum = strtoul(csum,NULL,16);
        int stats = check_crcsum(ipt,hexcsum);
        return stats;
    }
}

</code></pre>

<h2 id="参考文献">参考文献</h2>

<p><a href="https://www.xilinx.com/support/documentation/application_notes/xapp209.pdf">https://www.xilinx.com/support/documentation/application_notes/xapp209.pdf</a></p>

      </article>
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "kmahyyg" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </main>
    <nav class="end-nav side-padding">
      
      <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="https://www.kmahyyg.xyz/tech/ds04-maze-exp/" class="card blog-card" rel="bookmark" >
    
    <div class="card-img-container">
      <p class="card-img-overlay">Next Article</p>
      <picture>
        
        <source srcset="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_tech.webp">
        <img src="https://alicdn.kmahyyg.xyz/asset_files/aether/cat_tech.webp" class="card-img" >
      </picture>
    </div>
    
  <article class="card-body">
    <h2 class="card-title">数据结构实验 4 - 迷宫</h2>
    <p class="card-text">数据结构的迷宫实验的一个解法，有点复杂，记录一下</p>
    <div class="card-subtext muted-text">
      <p>Posted <time datetime="2018-10-18 1018:00">Oct 18, 2018</time></p>
      <p>#school #code </p>
    </div>
  </article>
</a>
      
      <a ontouchstart="cardPressed.call(this)" ontouchend="cardReleased.call(this)" ontouchmove="cardReleased.call(this)" 
  href="https://www.kmahyyg.xyz/" class="card home-card" style="background-image: url( https://alicdn.kmahyyg.xyz/asset_files/aether/backtohome.webp )" rel="bookmark" >
  Home
</a>
    </nav>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>
<script src="https://www.kmahyyg.xyz/js/core.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
  </body>
</html>